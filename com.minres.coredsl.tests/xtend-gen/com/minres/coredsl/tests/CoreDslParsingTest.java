/**
 * generated by Xtext 2.10.0
 */
package com.minres.coredsl.tests;

import com.google.inject.Inject;
import com.minres.coredsl.coreDsl.DescriptionContent;
import com.minres.coredsl.tests.CoreDslInjectorProvider;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.util.EcoreUtil;
import org.eclipse.xtend2.lib.StringConcatenation;
import org.eclipse.xtext.testing.InjectWith;
import org.eclipse.xtext.testing.XtextRunner;
import org.eclipse.xtext.testing.util.ParseHelper;
import org.eclipse.xtext.xbase.lib.Exceptions;
import org.junit.Assert;
import org.junit.Test;
import org.junit.runner.RunWith;

@RunWith(XtextRunner.class)
@InjectWith(CoreDslInjectorProvider.class)
@SuppressWarnings("all")
public class CoreDslParsingTest {
  @Inject
  private ParseHelper<DescriptionContent> parseHelper;
  
  public String addInstructionContext(final String str) {
    StringConcatenation _builder = new StringConcatenation();
    _builder.append("InstructionSet TestISA {");
    _builder.newLine();
    _builder.append("    ");
    _builder.append("registers { ");
    _builder.newLine();
    _builder.append("        ");
    _builder.append("[[is_pc]] int PC ;");
    _builder.newLine();
    _builder.append("        ");
    _builder.append("int Xreg[32];");
    _builder.newLine();
    _builder.append("        ");
    _builder.append("float Freg[32];");
    _builder.newLine();
    _builder.append("    ");
    _builder.append("}");
    _builder.newLine();
    _builder.append("    ");
    _builder.append("instructions {");
    _builder.newLine();
    _builder.append("        ");
    _builder.append(str, "        ");
    _builder.newLineIfNotEmpty();
    _builder.append("    ");
    _builder.append("}");
    _builder.newLine();
    _builder.append("}");
    _builder.newLine();
    return _builder.toString();
  }
  
  public String addInstructionSetContext(final String str) {
    StringConcatenation _builder = new StringConcatenation();
    _builder.append("InstructionSet TestISA {");
    _builder.newLine();
    _builder.append("    ");
    _builder.append(str, "    ");
    _builder.newLineIfNotEmpty();
    _builder.append("}");
    _builder.newLine();
    return _builder.toString();
  }
  
  @Test
  public void parseInstrPRELU() {
    try {
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("PRELU {");
      _builder.newLine();
      _builder.append("    ");
      _builder.append("encoding: b0000000 :: rs2[4:0] :: rs1[4:0] :: b000 :: rd[4:0] :: b1111011;  ");
      _builder.newLine();
      _builder.append("    ");
      _builder.append("args_disass:\"{name(rd)}, {name(rs1)}, {name(rs2)}\"; ");
      _builder.newLine();
      _builder.append("    ");
      _builder.append("behavior: {");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("static float alpha = 0.2;  ");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("float input, new_alpha;");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("input = Freg[rs1];  // read global F register");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("if (rs2!=0) // avoid having an additional instruction for setting parameter");
      _builder.newLine();
      _builder.append("            ");
      _builder.append("new_alpha = Freg[rs2];");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("else ");
      _builder.newLine();
      _builder.append("            ");
      _builder.append("new_alpha = alpha; // use the stored alpha when rs2==0");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("if(input > 0)");
      _builder.newLine();
      _builder.append("            ");
      _builder.append("Freg[rd] = input;");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("else ");
      _builder.newLine();
      _builder.append("            ");
      _builder.append("Freg[rd] = input*new_alpha; ");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("if (rs2!=0)");
      _builder.newLine();
      _builder.append("            ");
      _builder.append("alpha = new_alpha; // update internal alpha register");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("}");
      _builder.newLine();
      _builder.append("}");
      _builder.newLine();
      final String input = _builder.toString();
      final DescriptionContent content = this.parseHelper.parse(this.addInstructionContext(input));
      Assert.assertEquals(1, content.getDefinitions().size());
      final Resource resource = content.eResource();
      EcoreUtil.resolveAll(resource);
      Assert.assertEquals(0, resource.getErrors().size());
      Assert.assertEquals(0, resource.getWarnings().size());
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
  
  @Test
  public void parseInstrSBOX() {
    try {
      StringConcatenation _builder = new StringConcatenation();
      _builder.append("SBOX {");
      _builder.newLine();
      _builder.append("    ");
      _builder.append("encoding: b0000000 :: rs2[4:0] :: rs1[4:0] :: b000 :: rd[4:0] :: b1111011;  ");
      _builder.newLine();
      _builder.append("    ");
      _builder.append("args_disass:\"{name(rd)}, {name(rs1)}, {name(rs2)}\"; ");
      _builder.newLine();
      _builder.append("    ");
      _builder.append("behavior: {");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("unsigned int data_i;");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("data_i = (unsigned int) Xreg[rs1];  ");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("// contents of array omitted for for brevity        ");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("const unsigned char sbox[256] = { 0x63, 0x7c, 0};  ");
      _builder.newLine();
      _builder.append("        ");
      _builder.append("Xreg[rd] = sbox[data_i[31:24]] :: sbox[data_i[23:16]] :: sbox[data_i[15:8]] :: sbox[data_i[7:0]];");
      _builder.newLine();
      _builder.append("    ");
      _builder.append("}");
      _builder.newLine();
      _builder.append("}");
      _builder.newLine();
      final String input = _builder.toString();
      final DescriptionContent content = this.parseHelper.parse(this.addInstructionContext(input));
      Assert.assertEquals(1, content.getDefinitions().size());
      final Resource resource = content.eResource();
      EcoreUtil.resolveAll(resource);
      Assert.assertEquals(0, resource.getErrors().size());
      Assert.assertEquals(0, resource.getWarnings().size());
    } catch (Throwable _e) {
      throw Exceptions.sneakyThrow(_e);
    }
  }
}
